# v1.9.2 更新日志

发布日期：2025-12-02

## 🎉 新功能

### 编辑器增强
- **进度条显示**：翻译过程中显示实时进度条，让用户清楚了解翻译进度
- **气泡框多选功能**：支持同时选择多个气泡框进行批量操作，提高编辑效率

### Web UI 界面
- 新增基于 Flask 的 Web UI 管理界面
- 支持通过浏览器访问和管理翻译任务
- 提供直观的文件上传和任务管理功能
- 实时查看翻译进度和结果

### Docker 镜像支持
- 添加 Docker 镜像构建配置（实验性功能）
- 支持 CPU 和 GPU 两种版本
- 提供 docker-compose 配置文件
- 自动化 CI/CD 构建流程（GitHub Actions）
- 镜像自动推送到 Docker Hub：`hgmzhn/manga-translator`

## ⚡ 优化

### 翻译器架构改进
- **系统提示词与用户消息分离**：
  - OpenAI 和 OpenAI HQ：系统提示词（包括断句提示、自定义提示、基础系统提示）现在放在 `system` role，用户消息只包含上下文、待翻译文本和图片
  - Gemini 和 Gemini HQ：系统提示词放在 `system_instruction` 参数中，用户消息只包含上下文、待翻译文本和图片
  - 图片始终放在用户消息的最后
  - 更符合各 API 的最佳实践，提高翻译质量

- **智能重试机制**：
  - 新增重试提示功能，避免模型服务器缓存导致的重复错误
  - 当翻译质量不合格（数量不匹配、质量检查失败、BR 标记缺失）需要重试时，会在用户消息中添加重试次数和失败原因
  - 例如：`[Retry attempt #2] Reason: Translation count mismatch: expected 10, got 8`
  - 有效解决某些第三方 API 代理的缓存问题

### 检测和过滤
- **优化混合检测替换逻辑**：
  - 改进 YOLO OBB 检测器与主检测器的框合并算法
  - 现在支持 YOLO 框同时替换多个主检测器框（当 YOLO 框完全包含多个小框时）
  - 替换条件更严格：YOLO 框面积必须 >= 所有被包含主框总面积 × 2
  - 如果 YOLO 框包含主框但面积条件不满足，会删除 YOLO 框以避免误判
  
- **优化极端长宽比图片的面积过滤**：
  - 对于条漫等极端长宽比图片（长宽比 > 3），限制面积过滤参考块的最大长宽比为 3:1
  - 避免因切割块过大导致过滤标准过于宽松
  - 提高小文本框的检测准确率

### 日志系统
- **改进详细日志支持**：
  - 修复了勾选"详细日志"选项后 DEBUG 级别日志不显示的问题
  - 现在启用详细日志后可以看到被过滤框的详细信息（大小、面积、占比、文本内容）

### 编辑器文件列表
- 重构文件夹树结构管理，使用显式树结构代替递归推断
- 优化文件列表传递逻辑，确保主页和编辑器显示一致
- 改进文件/文件夹删除逻辑，修复删除子文件夹时列表清空的问题
- 添加完整的文件夹层级显示，包括顶层文件夹

### 文件排除逻辑
- 优化被删除文件/文件夹的排除机制
- 确保传递给翻译后端的文件列表正确排除已删除内容
- 改进子文件夹和单个文件的删除处理

### 日志输出
- 清理编辑器中的调试日志
- 保留翻译主流程的关键日志
- 减少不必要的日志输出，提升可读性

## 🐛 Bug修复

### 编辑器
- **修复导出文本框残留问题**：修复了删除文本框后，导出时仍然包含已删除文本框的bug
- 修复从主页点击图片进入编辑器时，文件夹结构不完整的问题
- 修复删除子文件夹后整个文件列表被清空的问题
- 修复编辑器文件列表与主页显示不一致的问题

### Web 服务器
- **修复管理员配置保存**：
  - 修复了并发数设置无法保存的问题
  - 修复了公告设置无法保存的问题
  - 所有管理员设置现在都能正确持久化到配置文件
- **优化初始设置流程**：
  - 用户首次访问时，如果管理员密码未设置，会提示先设置管理员密码
  - 改进了初始设置界面的显示逻辑

---

## 📝 技术细节

### 翻译器消息结构优化

**OpenAI 系列**：
```python
messages = [
    {"role": "system", "content": "断句提示词\n\n自定义提示词\n\n基础系统提示词"},
    {"role": "user", "content": [文本, 图片...]}  # 图片在最后
]
```

**Gemini 系列**：
```python
# 初始化时
GenerativeModel(
    model_name="gemini-1.5-flash",
    system_instruction="断句提示词\n\n自定义提示词\n\n基础系统提示词"
)

# 发送时
contents = [文本, 图片...]  # 图片在最后
```

**重试提示示例**：
```
[Retry attempt #2] Reason: Quality check failed: Empty translation detected

Please translate the following manga text regions:
1. こんにちは
2. さようなら
...
```

### 混合检测算法改进
之前的逻辑只检查 YOLO 框是否完全包含**单个**主检测器框，可能导致以下问题：
- YOLO 框包含了主检测器的框 A 和框 B
- 但只满足"完全包含框 A"且"面积 >= 框 A × 2"
- 结果只替换框 A，框 B 仍保留，导致重复检测

新逻辑改为：
- 计算 YOLO 框包含的**所有**主检测器框的总面积
- 要求 YOLO 框面积 >= 总面积 × 2
- 如果条件满足，替换所有被包含的主框
- 如果条件不满足，删除 YOLO 框（说明检测错误）

### 极端长宽比图片过滤优化
对于长宽比 > 3 的条漫图片，检测器会将图片切割成多个块进行检测。之前的面积过滤使用实际切割块面积作为参考，但切割块本身可能长宽比过大（如 5:1），导致过滤标准过于宽松。

新逻辑：
- 限制面积过滤参考块的最大长宽比为 3:1
- 例如：实际切割块为 3600×720（长宽比 5:1），过滤时使用 2160×720（长宽比 3:1）作为参考
- 这样可以更准确地过滤掉噪点，同时保留真正的文本框

---

## 升级说明

### Docker 使用（实验性）

```bash
# 拉取镜像
docker pull your-username/manga-translator:latest-cpu

# 或使用 docker-compose
cd packaging
docker-compose up -d
```

**注意：** Docker 镜像功能目前处于实验阶段，可能存在未知问题。

### 常规升级

请参考项目文档中的安装和升级指南。

